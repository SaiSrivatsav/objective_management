sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/core/BusyIndicator","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox"],(e,t,o,i,s,n)=>{"use strict";return e.extend("mboobjectives.controller.Main",{onInit(){var e=this.getOwnerComponent().getRouter();e.getRoute("RouteMain").attachPatternMatched(this._onObjectMatched,this)},async _onObjectMatched(){this._i18nModel=this.getOwnerComponent().getModel("i18n").getResourceBundle();this.getOwnerComponent().getModel("MboDetails").setData([]);this.getOwnerComponent().getModel("Participants").setData([]);o.show();await this.getParticipants();o.hide()},async getParticipants(){const e=this.getView().getModel("Participants");e.setData([]);e.setSizeLimit(1e3);const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.commissionsService.uri);var i=[];let s=0;const r=100;let a=true;try{while(a){const e=await fetch(`${t}/participants?skip=${s}&top=${r}`,{method:"GET",contentType:"application/json",dataType:"json"});if(!e.ok){throw new Error("Network response was not ok")}const o=await e.json();const n=Array.isArray(o.participants)?o.participants:o.value||[];if(n.length>0){i.push(...n)}if(n.length<r){a=false}else{s+=r}}e.setData(i.flat())}catch(e){o.hide();n.error("Error fetching participants:",e);console.error("Error fetching participants:",e)}},async onTerritoryChange(e){const t=this.getView().getModel("Participants");const o=e.getSource().getSelectedKey();const i=t.getData().filter(e=>e.userId===o);this.getView().byId("idParticipantName").setText(i.length>0?i[0].firstName+" "+i[0].lastName:"");this.getView().byId("idTargetComp").setText(i.length>0?i[0]?.salary?.value+" "+i[0]?.salary?.unitType?.name:"");const s=await this.getPosition(i[0].payeeSeq);if(s){this.getView().byId("idPosition").setText(s)}await this.getMboDetails(o)},async getMboDetails(e){const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);try{o.show();const i=await fetch(`${t}/MboDetails?$filter=territoryId eq '${e}'`,{method:"GET",contentType:"application/json",dataType:"json"});if(!i.ok){throw new Error("Network response was not ok")}const s=await i.json();const n=Array.isArray(s.mbos)?s.mbos:s.value||[];const r=this.getView().getModel("MboDetails");r.setData(n);o.hide()}catch(e){o.hide();n.error("Error fetching MBO details:",e);console.error("Error fetching MBO details:",e)}},onSaveObjectives(e){const i=this.getView().getModel("MboDetails");const s=i.getData();const r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push({territoryId:this.getView().byId("idTerritoryId").getSelectedKey(),position:this.getView().byId("idPosition").getText(),participantName:this.getView().byId("idParticipantName").getText(),objectiveId:t.objectiveId||null,objective:t.objective,mboWeightage:t.mboWeightage,comments:t.comments,mboScore:t.mboScore})}const a=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.mainService.uri);o.show();fetch(`${a}/saveMBOObjectives`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mboData:r})}).then(e=>{o.hide();if(!e.ok){throw new Error("Network response was not ok")}return e.json()}).then(e=>{t.show("MBO Objectives saved successfully")}).catch(e=>{o.hide();n.error("Error saving MBO details:",e);console.error("Error saving MBO details:",e)})},async getPosition(e){const t=this.getOwnerComponent().getManifestObject().resolveUri(this.getOwnerComponent().getManifestEntry("sap.app").dataSources.commissionsService.uri);try{const o=await fetch(`${t}/positions?$filter=payee eq '${e}'`,{method:"GET",contentType:"application/json",dataType:"json"});if(!o.ok){throw new Error("Network response was not ok")}const i=await o.json();const s=Array.isArray(i.positions)?i.positions:i.value||[];return s[s.length-1].description}catch(e){o.hide();n.error("Error fetching position:",e);console.error("Error fetching position:",e)}},onAddObjective(e){const t=this.getView().getModel("MboDetails");let o=t.getData();if(!Array.isArray(o)){o=[]}const i={objective:"",mboWeightage:"",comments:"",mboScore:""};o.push(i);t.setData(o);if(typeof t.refresh==="function"){t.refresh(true)}},onDeleteObjective(e){o.show();const t=Number(e.getParameter("listItem").getBindingContext("MboDetails").sPath.split("/")[1]);const i=this.getView().getModel("MboDetails");let s=i.getData();s.splice(t,1);i.setData(s);if(typeof i.refresh==="function"){i.refresh(true);o.hide()}}})});
//# sourceMappingURL=Main.controller.js.map